# Qwen3-ASR-GGUF é¡¹ç›®æ¶æ„æ–‡æ¡£

> æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0  
> æœ€åæ›´æ–°ï¼š2026-02-23  
> **æ¨èé˜…è¯»é¡ºåºï¼šç¬¬ â‘  é¡ºä½**ï¼ˆé¡¹ç›®å…¥é—¨é¦–é€‰ï¼‰

---

## ğŸ“‹ æœ¬æ–‡æ¡£é˜…è¯»æŒ‡å—

### åœ¨å®Œæ•´é¡¹ç›®æ–‡æ¡£ä¸­çš„é˜…è¯»é¡ºåº

| é¡ºä½ | æ–‡æ¡£ | æ–‡ä»¶å | ç›®æ ‡è¯»è€… | é¢„è®¡è€—æ—¶ |
|:----:|------|--------|----------|----------|
| **â‘ ** | **é¡¹ç›®æ¶æ„** | `ARCHITECTURE.md` | æƒ³äº†è§£é¡¹ç›®æ•´ä½“è®¾è®¡ | 1-2 å°æ—¶ |
| **â‘¡** | [é›†æˆæŒ‡å—](./INTEGRATION.md) | `INTEGRATION.md` | æƒ³å¿«é€Ÿä½¿ç”¨é¡¹ç›® | 1-2 å°æ—¶ |
| **â‘¢** | [å­¦ä¹ è®¡åˆ’](./LEARNING_PLAN.md) | `LEARNING_PLAN.md` | æƒ³æ·±å…¥ç†è§£åŸç† | 4-12 å‘¨ |
| **â‘£** | [å¯¼å‡ºæŒ‡å—](./EXPORT_GUIDE.md) | `EXPORT_GUIDE.md` | æƒ³è½¬æ¢è‡ªå·±çš„æ¨¡å‹ | 2-4 å°æ—¶ |
| **â‘¤** | [æºç è§£æ](./SOURCE_CODE.md) | `SOURCE_CODE.md` | æƒ³ä¿®æ”¹/æ‰©å±•åŠŸèƒ½ | 4-8 å‘¨ |

### æœ¬æ–‡æ¡£ç»“æ„

```
é˜…è¯»å»ºè®®ï¼šæŒ‰é¡ºåºé˜…è¯»ï¼Œæˆ–è·³è½¬åˆ°æ„Ÿå…´è¶£çš„éƒ¨åˆ†

1. é¡¹ç›®æ¦‚è¿°         â”€â”€â”€â”€â”€â”€â–¶ äº†è§£é¡¹ç›®å®šä½å’Œæ€§èƒ½æŒ‡æ ‡
2. ç³»ç»Ÿæ¶æ„æ€»è§ˆ     â”€â”€â”€â”€â”€â”€â–¶ ç†è§£æ•´ä½“è®¾è®¡å’Œè¿›ç¨‹æ¶æ„
3. æ ¸å¿ƒæ¨¡å—è¯¦è§£     â”€â”€â”€â”€â”€â”€â–¶ æ·±å…¥å„å¤§æ¨¡å—çš„å·¥ä½œåŸç†
4. æ•°æ®æµä¸å·¥ä½œæµç¨‹ â”€â”€â”€â”€â”€â”€â–¶ ç†è§£æ•°æ®å¦‚ä½•æµåŠ¨å’Œå¤„ç†
5. æ¨¡å‹å¯¼å‡ºæµç¨‹     â”€â”€â”€â”€â”€â”€â–¶ äº†è§£æ¨¡å‹å¦‚ä½•è½¬æ¢
6. æŠ€æœ¯äº®ç‚¹ä¸ä¼˜åŒ–   â”€â”€â”€â”€â”€â”€â–¶ å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
7. å¿«é€Ÿå‚è€ƒ         â”€â”€â”€â”€â”€â”€â–¶ API å’Œå‘½ä»¤è¡Œé€ŸæŸ¥
```

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#2-ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#3-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [æ•°æ®æµä¸å·¥ä½œæµç¨‹](#4-æ•°æ®æµä¸å·¥ä½œæµç¨‹)
5. [æ¨¡å‹å¯¼å‡ºæµç¨‹](#5-æ¨¡å‹å¯¼å‡ºæµç¨‹)
6. [æŠ€æœ¯äº®ç‚¹ä¸ä¼˜åŒ–](#6-æŠ€æœ¯äº®ç‚¹ä¸ä¼˜åŒ–)
7. [å¿«é€Ÿå‚è€ƒ](#7-å¿«é€Ÿå‚è€ƒ)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

æœ¬é¡¹ç›®å°† **Qwen3-ASR è¯­éŸ³è¯†åˆ«æ¨¡å‹** è½¬æ¢ä¸ºå¯æœ¬åœ°é«˜æ•ˆè¿è¡Œçš„æ··åˆæ ¼å¼ï¼Œå®ç°**å¿«é€Ÿã€å‡†ç¡®çš„ç¦»çº¿è¯­éŸ³è¯†åˆ«**ã€‚

æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š
- **æ··åˆæ¨ç†æ¶æ„**ï¼šONNX (Encoder) + GGUF (Decoder)
- **å¤šè¿›ç¨‹å¹¶è¡Œ**ï¼šç¼–ç ã€å¯¹é½ä¸è§£ç å¼‚æ­¥æ‰§è¡Œ
- **é‡åŒ–ä¼˜åŒ–**ï¼šINT4 Encoder + Q4_K GGUFï¼Œæœ€å°åŒ–æ˜¾å­˜å ç”¨

### 1.2 æ”¯æŒçš„æ¨¡å‹

| æ¨¡å‹ | å‚æ•°é‡ | ç”¨é€” |
|------|--------|------|
| Qwen3-ASR-0.6B | 0.6B | è½»é‡çº§è¯­éŸ³è¯†åˆ« |
| Qwen3-ASR-1.7B | 1.7B | é«˜ç²¾åº¦è¯­éŸ³è¯†åˆ« |
| Qwen3-ForcedAligner-0.6B | 0.6B | å­—çº§æ—¶é—´æˆ³å¯¹é½ |

### 1.3 æ€§èƒ½æŒ‡æ ‡

ä»¥ 1.7B æ¨¡å‹åœ¨ RTX 5050 ç¬”è®°æœ¬ä¸Šä¸ºä¾‹ï¼ˆ50 ç§’ä¸­æ–‡éŸ³é¢‘ï¼‰ï¼š

| æŒ‡æ ‡ | GPU (DML) | CPU |
|------|-----------|-----|
| RTF (å®æ—¶ç‡) | 0.052 | 0.390 |
| æ€»å¤„ç†è€—æ—¶ | 2.59 ç§’ | 19.60 ç§’ |
| LLM é¢„å¡«å……é€Ÿåº¦ | 4149 tokens/s | 162 tokens/s |
| LLM ç”Ÿæˆé€Ÿåº¦ | 114 tokens/s | 27 tokens/s |
| æ˜¾å­˜å ç”¨ | ~900MB | N/A |

---

## 2. ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 2.1 è¿›ç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸»è¿›ç¨‹ (Main Process)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   QwenASREngine                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ éŸ³é¢‘é¢„å¤„ç†   â”‚  â”‚ ASR Decoder  â”‚  â”‚ ç»“æœå¯¼å‡ºå™¨    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (åˆ‡ç‰‡/è®°å¿†)  â”‚â”€â”€â–¶â”‚ (GGUF/LLM)   â”‚â”€â”€â–¶â”‚ (TXT/SRT/JSON)â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                        â”‚                              â”‚
â”‚         â”‚ Queue (to_worker_q)    â”‚ Queue (from_enc_q)          â”‚
â”‚         â–¼                        â–¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â”‚                        â”‚ Queue (from_align_q)
         â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¾…åŠ©è¿›ç¨‹ (Worker Process)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  QwenAudioEncoderâ”‚    â”‚ QwenForcedAlignerâ”‚                  â”‚
â”‚  â”‚  (ONNX Runtime)  â”‚    â”‚   (GGUF/LLM)     â”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚ Frontend   â”‚  â”‚    â”‚  â”‚  Encoder   â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚ (CNN)      â”‚  â”‚    â”‚  â”‚  (ONNX)    â”‚  â”‚                  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                  â”‚
â”‚  â”‚  â”‚ Backend    â”‚  â”‚    â”‚  â”‚  Decoder   â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚ (Transformer)â”‚  â”‚  â”‚  â”‚  (GGUF)    â”‚  â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                        â”‚                              â”‚
â”‚         â”‚ è¿”å› Embedding         â”‚ è¿”å›å¯¹é½ç»“æœ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—ä¾èµ–å…³ç³»

```
transcribe.py (ç”¨æˆ·å…¥å£)
    â”‚
    â–¼
qwen_asr_gguf/inference/
â”œâ”€â”€ asr.py              # æ ¸å¿ƒå¼•æ“ (QwenASREngine)
â”‚   â”œâ”€â”€ encoder.py      # éŸ³é¢‘ç¼–ç  (ONNX)
â”‚   â”œâ”€â”€ aligner.py      # æ—¶é—´æˆ³å¯¹é½ (GGUF)
â”‚   â”œâ”€â”€ llama.py        # llama.cpp ç»‘å®š
â”‚   â”œâ”€â”€ asr_worker.py   # è¾…åŠ©è¿›ç¨‹é€»è¾‘
â”‚   â”œâ”€â”€ schema.py       # æ•°æ®ç»“æ„å®šä¹‰
â”‚   â”œâ”€â”€ exporters.py    # ç»“æœå¯¼å‡º (SRT/JSON/TXT)
â”‚   â”œâ”€â”€ chinese_itn.py  # ä¸­æ–‡æ•°å­—è§„æ•´
â”‚   â””â”€â”€ utils.py        # å·¥å…·å‡½æ•°
â”‚
qwen_asr_gguf/export/   # æ¨¡å‹å¯¼å‡ºå·¥å…·
â”œâ”€â”€ convert_hf_to_gguf.py
â”œâ”€â”€ gguf/
â””â”€â”€ qwen3_asr_custom/
```

### 2.3 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| **Encoder** | ONNX Runtime | éŸ³é¢‘ç‰¹å¾æå–ï¼Œæ”¯æŒ DML/Vulkan |
| **Decoder** | llama.cpp | LLM æ¨ç†ï¼Œæ”¯æŒ GGUF é‡åŒ–æ ¼å¼ |
| **éŸ³é¢‘å¤„ç†** | NumPy + SciPy | Mel é¢‘è°±è®¡ç®— |
| **å‘½ä»¤è¡Œ** | Typer + Rich | CLI äº¤äº’ç•Œé¢ |
| **æ‰“åŒ…** | PyInstaller | å•æ–‡ä»¶å¯æ‰§è¡Œåˆ†å‘ |

---

## 3. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 3.1 QwenASREngine (asr.py)

**èŒè´£**ï¼šæµå¼è½¬å½•å¼•æ“ï¼Œåè°ƒç¼–ç ã€è§£ç ã€å¯¹é½ä¸‰å¤§ä»»åŠ¡ã€‚

#### æ ¸å¿ƒæ–¹æ³•

```python
class QwenASREngine:
    def __init__(self, config: ASREngineConfig):
        """åˆå§‹åŒ–å¼•æ“ï¼Œå¯åŠ¨è¾…åŠ©è¿›ç¨‹ï¼ŒåŠ è½½ LLM"""
        
    def transcribe(audio_file, language, context, ...) -> TranscribeResult:
        """ä»æ–‡ä»¶åŠ è½½éŸ³é¢‘å¹¶æ‰§è¡Œå®Œæ•´è½¬å½•"""
        
    def asr(audio, chunk_size_sec, memory_chunks, ...) -> TranscribeResult:
        """æ ¸å¿ƒè½¬å½•æµæ°´çº¿ (ä¸‰çº§æµæ°´çº¿)"""
```

#### ä¸‰çº§æµæ°´çº¿è®¾è®¡

ä¸»å¾ªç¯é‡‡ç”¨ **i+1 é¢„å–ã€i è¯†åˆ«ã€i-1 å¯¹é½** çš„ä¸‰çº§æµæ°´çº¿ï¼š

```
æ—¶é—´çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

Chunk 0:  [ç¼–ç  0] â”€â”€â–¶ [è¯†åˆ« 0] â”€â”€â–¶ [å¯¹é½ 0]
                        â”‚
Chunk 1:                 [ç¼–ç  1] â”€â”€â–¶ [è¯†åˆ« 1] â”€â”€â–¶ [å¯¹é½ 1]
                                      â”‚
Chunk 2:                               [ç¼–ç  2] â”€â”€â–¶ [è¯†åˆ« 2] â”€â”€â–¶ [å¯¹é½ 2]
```

#### è®°å¿†ç®¡ç†æœºåˆ¶

```python
asr_memory = deque(maxlen=memory_chunks)  # é»˜è®¤ä¿ç•™ 1 ä¸ªå†å²ç‰‡æ®µ

# æ¯ä¸ªç‰‡æ®µè¯†åˆ«æ—¶ï¼Œå°†å†å²ç‰‡æ®µçš„ embedding å’Œæ–‡æœ¬æ‹¼æ¥ä¸ºä¸Šä¸‹æ–‡
prefix_text = "".join([m[1] for m in asr_memory])  # å†å²æ–‡æœ¬
combined_audio = np.concatenate([m[0] for m in asr_memory] + [audio_feature])
```

#### Prompt æ„å»ºç­–ç•¥

```python
def _build_prompt_embd(audio_embd, prefix_text, context, language):
    """
    æ„é€  LLM è¾“å…¥çš„ Embedding åºåˆ—ï¼š
    
    [IM_START] System [IM_END] [IM_START] User [AUDIO_START]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         Block A                    Block A
    
    [Audio Embedding] [AUDIO_END] [IM_END] [IM_START] Assistant [LANG] [ASR_TEXT] [Prefix]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         Block B                              Block C
    """
```

### 3.2 QwenAudioEncoder (encoder.py)

**èŒè´£**ï¼šéŸ³é¢‘ â†’ Mel é¢‘è°± â†’ éŸ³é¢‘ç‰¹å¾ Embedding

#### æ¶æ„è®¾è®¡

```
éŸ³é¢‘è¾“å…¥ (16kHz, float32)
    â”‚
    â–¼
FastWhisperMel  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”œâ”€ åˆ†å¸§ (Hann çª—)             â”‚
  â”œâ”€ FFT (å®æ•°)                 â”‚ 128 ç»´ Mel é¢‘è°±
  â”œâ”€ Mel æ»¤æ³¢                   â”‚ (128, T)
  â””â”€ å¯¹æ•°å½’ä¸€åŒ–                 â”‚
    â”‚                          â”‚
    â–¼                          â–¼
QwenAudioEncoder (Split æ¨¡å¼)
    â”‚
    â”œâ”€ Frontend (CNN) â”€â”€â”€â”€â”€â”€â”€â”€â–¶ åˆ†ç‰‡æ¨ç† (100 å¸§/ç‰‡)
    â”‚   â”œâ”€ Mel åˆ†å—             â”‚
    â”‚   â”œâ”€ CNN ç‰¹å¾æå–          â”‚
    â”‚   â””â”€ æ‹¼æ¥ + åˆ‡ç‰‡           â”‚
    â”‚                          â”‚
    â–¼                          â”‚
Backend (Transformer) â—€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”œâ”€ Attention Mask (å…¨ 0)
  â””â”€ Transformer ç¼–ç 
    â”‚
    â–¼
éŸ³é¢‘ Embedding (T, 896/1024)
```

#### å…³é”®æŠ€æœ¯ç‚¹

1. **Split ONNX è®¾è®¡**ï¼š
   - Frontendï¼šå¤„ç† 100 å¸§åˆ†ç‰‡ï¼Œè¾“å‡º 13 å¸§ç‰¹å¾
   - Backendï¼šå¤„ç†å®Œæ•´åºåˆ—ï¼Œè¾“å‡ºæœ€ç»ˆ Embedding
   - ä¼˜åŠ¿ï¼šé¿å…é•¿åºåˆ— Attention çš„ O(nÂ²) å†…å­˜å¼€é”€

2. **é•¿åº¦è®¡ç®—**ï¼š
   ```python
   def get_feat_extract_output_lengths(input_lengths):
       input_lengths_leave = input_lengths % 100
       feat_lengths = (input_lengths_leave - 1) // 2 + 1
       output_lengths = ((feat_lengths - 1) // 2 + 1 - 1) // 2 + 1 + (input_lengths // 100) * 13
       return int(output_lengths)
   ```

3. **Mel æå–ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ `np.lib.stride_tricks.as_strided` é›¶æ‹·è´åˆ†å¸§
   - é¢„è®¡ç®— Hann çª—å’Œ Mel æ»¤æ³¢å™¨ç»„
   - æ—  librosa ä¾èµ–ï¼Œæ¶ˆé™¤ Numba JIT å¯åŠ¨å»¶æ—¶

### 3.3 QwenForcedAligner (aligner.py)

**èŒè´£**ï¼šéŸ³é¢‘ + æ–‡æœ¬ â†’ å­—çº§æ—¶é—´æˆ³

#### å¯¹é½åŸç†

```
è¾“å…¥ï¼šéŸ³é¢‘ Embedding + æ–‡æœ¬ "ä½ å¥½ä¸–ç•Œ"
    â”‚
    â–¼
åˆ†è¯ï¼š["ä½ ", "å¥½", "ä¸–", "ç•Œ"]
    â”‚
    â–¼
æ„å»º Prompt:
[<|audio_start|>] [Audio Embedding] [<|audio_end|>]
[ä½ ] [<TS1>] [<TS2>] [å¥½] [<TS3>] [<TS4>] [ä¸–] [<TS5>] [<TS6>] [ç•Œ] [<TS7>] [<TS8>]
    â”‚
    â–¼
LLM æ¨ç† (ä»…è®¡ç®— <TS> ä½ç½®çš„ Logits)
    â”‚
    â–¼
è§£æ Timestamp Token â†’ æ¯«ç§’å€¼ (step=80ms)
    â”‚
    â–¼
åå¤„ç†ï¼š
  â”œâ”€ fix_timestamps()  â”€â”€â–¶ å•è°ƒé€’å¢ä¿®æ­£ (LIS ç®—æ³•)
  â””â”€ reconcile()         â”€â”€â–¶ æ ‡ç‚¹ç¬¦å·å›å¡«
    â”‚
    â–¼
è¾“å‡ºï¼šForcedAlignItem åˆ—è¡¨
```

#### æ—¶é—´æˆ³ä¿®æ­£ç®—æ³•

```python
def fix_timestamps(data: np.ndarray) -> List[int]:
    """
    ä½¿ç”¨ LIS (æœ€é•¿é€’å¢å­åºåˆ—) æ£€æµ‹å¼‚å¸¸æ—¶é—´ç‚¹ï¼š
    1. æ‰¾å‡ºæœ€é•¿çš„å•è°ƒé€’å¢å­åºåˆ—
    2. æ ‡è®°éé€’å¢ç‚¹ä¸ºå¼‚å¸¸
    3. æ ¹æ®å¼‚å¸¸æ•°é‡é‡‡ç”¨ä¸åŒæ’å€¼ç­–ç•¥ï¼š
       - â‰¤2 ä¸ªï¼šå°±è¿‘å¡«å……
       - >2 ä¸ªï¼šçº¿æ€§æ’å€¼
    """
```

#### å¤šè¯­è¨€åˆ†è¯æ”¯æŒ

| è¯­è¨€ | åˆ†è¯ç­–ç•¥ |
|------|----------|
| ä¸­æ–‡ | é€å­—æ‹†åˆ† (CJK å­—ç¬¦) |
| è‹±æ–‡ | æŒ‰ç©ºæ ¼åˆ†è¯ |
| æ—¥æ–‡ | nagisa åˆ†è¯åº“ |
| éŸ©æ–‡ | soynlp åˆ†è¯åº“ |

### 3.4 Llama ç»‘å®š (llama.py)

**èŒè´£**ï¼šå°è£… llama.cpp C APIï¼Œæä¾› Python æ¥å£

#### æ ¸å¿ƒç±»

```python
class LlamaModel:
    """GGUF æ¨¡å‹å°è£…"""
    def __init__(self, path):
        self.ptr = load_model(path)
        self.n_embd = ...
        self.eos_token = ...
    
    def tokenize(text) -> List[int]
    def detokenize(tokens) -> str
    def token_to_id(text) -> int

class LlamaContext:
    """æ¨ç†ä¸Šä¸‹æ–‡"""
    def __init__(self, model, n_ctx, n_batch, ...)
    def decode(batch)
    def clear_kv_cache()
    def get_logits_ith(i)

class LlamaBatch:
    """æ‰¹å¤„ç†å°è£…"""
    def set_embd(data, pos, seq_id)
    # æ”¯æŒ Embedding ç›´æ¥æ³¨å…¥å’Œå¤æ‚ä½ç½®ç¼–ç 

class LlamaSampler:
    """é‡‡æ ·å™¨é“¾"""
    def __init__(self, temperature, top_k, top_p, seed)
    def sample(ctx) -> token
```

#### é‡åŒ–æ ¼å¼æ”¯æŒ

| æ ¼å¼ | è¯´æ˜ | ç²¾åº¦æŸå¤± |
|------|------|----------|
| F32 | åŸå§‹ç²¾åº¦ | 0% |
| F16 | åŠç²¾åº¦ | ~0.1% |
| Q4_K | 4-bit é‡åŒ– (K-quants) | ~0.5% |
| Q8_0 | 8-bit é‡åŒ– | ~0.2% |

### 3.5 è¾…åŠ©è¿›ç¨‹ (asr_worker.py)

**èŒè´£**ï¼šåœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­æ‰§è¡Œç¼–ç å’Œå¯¹é½ä»»åŠ¡ï¼Œé¿å… GIL é™åˆ¶

#### é€šä¿¡åè®®

```python
class MsgType(Enum):
    CMD_ENCODE = auto()   # ä¸»è¿›ç¨‹ â†’ Worker: ç¼–ç è¯·æ±‚
    CMD_ALIGN = auto()    # ä¸»è¿›ç¨‹ â†’ Worker: å¯¹é½è¯·æ±‚
    CMD_STOP = auto()     # ä¸»è¿›ç¨‹ â†’ Worker: åœæ­¢
    MSG_EMBD = auto()     # Worker â†’ ä¸»è¿›ç¨‹ï¼šè¿”å› Embedding
    MSG_ALIGN = auto()    # Worker â†’ ä¸»è¿›ç¨‹ï¼šè¿”å›å¯¹é½ç»“æœ
    MSG_READY = auto()    # Worker â†’ ä¸»è¿›ç¨‹ï¼šå°±ç»ªä¿¡å·
    MSG_ERROR = auto()    # Worker â†’ ä¸»è¿›ç¨‹ï¼šé”™è¯¯ä¿¡å·
```

#### è¿›ç¨‹æ‹“æ‰‘

```
ä¸»è¿›ç¨‹                          è¾…åŠ©è¿›ç¨‹
  â”‚                              â”‚
  â”œâ”€â”€ to_worker_q â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                              â”‚ æ¥æ”¶ä»»åŠ¡
  â”‚                              â”œâ”€ do_encode_task()
  â”‚                              â””â”€ do_align_task()
  â”‚                              â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€ from_enc_q â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ è¿”å› Embedding
  â”‚                              â”‚
  â”‚â—€â”€â”€â”€â”€â”€ from_align_q â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ è¿”å›å¯¹é½ç»“æœ
```

---

## 4. æ•°æ®æµä¸å·¥ä½œæµç¨‹

### 4.1 å®Œæ•´è½¬å½•æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Main as QwenASREngine
    participant Worker as è¾…åŠ©è¿›ç¨‹
    participant Encoder as ONNX Encoder
    participant Decoder as GGUF Decoder
    participant Aligner as Aligner

    User->>Main: transcribe(audio_file)
    
    Main->>Main: åŠ è½½éŸ³é¢‘ï¼Œåˆ†ç‰‡ (40s/chunk)
    Main->>Worker: å¯åŠ¨è¿›ç¨‹
    
    loop æ¯ä¸ª Chunk (ä¸‰çº§æµæ°´çº¿)
        Note over Main,Worker: i=0,1,2...
        
        Main->>Worker: CMD_ENCODE(chunk[i+1])
        Worker->>Encoder: encode(audio)
        Encoder-->>Worker: Embedding
        
        Main->>Worker: CMD_ALIGN(chunk[i-1])
        Worker->>Aligner: align(audio, text)
        Aligner-->>Worker: Timestamps
        
        Worker-->>Main: MSG_EMBD(chunk[i])
        Main->>Decoder: decode(embedding)
        Decoder-->>Main: Text
    end
    
    Main->>Worker: CMD_STOP
    Main->>Main: å¯¼å‡ºç»“æœ (TXT/SRT/JSON)
    Main-->>User: TranscribeResult
```

### 4.2 éŸ³é¢‘åˆ‡ç‰‡ç­–ç•¥

```
åŸå§‹éŸ³é¢‘ (50 ç§’)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunk 0 â”‚ Chunk 1 â”‚ Chunk 2 â”‚ Chunk 3 â”‚
â”‚  0-40s  â”‚ 40-50s  â”‚         â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚         â”‚
    â”‚         â”‚         â”‚         â”‚ è®°å¿†ï¼š[Chunk 2 text]
    â”‚         â”‚         â”‚ è¯†åˆ«ï¼š[Chunk 2 + memory]
    â”‚         â”‚ å¯¹é½ï¼šChunk 0
    â”‚ è¯†åˆ«ï¼š[Chunk 1 + memory]
    è®°å¿†ï¼š[Chunk 0 text]
```

### 4.3 è®°å¿†ä¸Šä¸‹æ–‡æœºåˆ¶

```python
# é»˜è®¤é…ç½®
chunk_size = 40.0   # æ¯ç‰‡ 40 ç§’
memory_num = 1      # è®°å¿† 1 ä¸ªå†å²ç‰‡æ®µ

# è¯†åˆ« Chunk 1 æ—¶çš„è¾“å…¥æ„æˆ
prefix_text = "Chunk 0 çš„è½¬å½•æ–‡æœ¬"
audio_embd = concat([Chunk_0_embedding, Chunk_1_embedding])

# LLM Prompt ç»“æ„
system: "You are a helpful assistant."
user: "<|audio_start|> [Chunk0+1 Audio] <|audio_end|>"
assistant: "language Chinese<asr_text> Chunk0 æ–‡æœ¬"
```

---

## 5. æ¨¡å‹å¯¼å‡ºæµç¨‹

### 5.1 ASR æ¨¡å‹å¯¼å‡º

```bash
# === é˜¶æ®µ 1: Encoder å¯¼å‡º ===
python 01-Export-ASR-Encoder-Frontend.py     # å¯¼å‡º CNN å‰ç«¯
python 02-Export_ASR-Encoder-Backend.py      # å¯¼å‡º Transformer åç«¯
python 03-Optimize-ASR-Encoder.py            # ONNX ä¼˜åŒ– (å¸¸é‡æŠ˜å ã€ç®—å­èåˆ)
python 04-Quantize-ASR-Encoder.py            # é‡åŒ– (FP16/INT8/INT4)

# === é˜¶æ®µ 2: Decoder å¯¼å‡º ===
python 05-Export-ASR-Decoder-HF.py           # æå– HuggingFace æƒé‡
python 06-Convert-ASR-Decoder-GGUF.py        # è½¬ä¸º GGUF (FP16)
python 07-Quantize-ASR-Decoder-GGUF.py       # GGUF é‡åŒ– (Q4_K)
```

### 5.2 Aligner æ¨¡å‹å¯¼å‡º

```bash
# æµç¨‹ä¸ ASR ç›¸åŒï¼Œè„šæœ¬ç¼–å· 11-17
python 11-Export-Aligner-Encoder-Frontend.py
python 12-Export-Aligner-Encoder-Backend.py
python 13-Optimize-Aligner-Encoder.py
python 14-Quantize-Aligner-Encoder.py
python 15-Export-Aligner-Decoder-HF.py
python 16-Convert-Aligner-Decoder-GGUF.py
python 17-Quantize-Aligner-Decoder-GGUF.py
```

### 5.3 é‡åŒ–ç²¾åº¦å¯¹æ¯”

| ç»„ä»¶ | é‡åŒ–æ–¹æ¡ˆ | ç›¸ä¼¼åº¦/å›°æƒ‘åº¦ | æ˜¾å­˜å ç”¨ |
|------|----------|---------------|----------|
| Encoder | INT4 | ä½™å¼¦ç›¸ä¼¼åº¦ 96% | 473MB |
| Decoder | Q4_K | å›°æƒ‘åº¦ +8.7% | 1064MB |

---

## 6. æŠ€æœ¯äº®ç‚¹ä¸ä¼˜åŒ–

### 6.1 æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | æŠ€æœ¯ | æ•ˆæœ |
|--------|------|------|
| **å¤šè¿›ç¨‹å¹¶è¡Œ** | ç¼–ç ã€å¯¹é½ä¸è§£ç å¼‚æ­¥ | æ¶ˆé™¤è®¡ç®—ç“¶é¢ˆ |
| **Split ONNX** | Encoder åˆ†å‰åç«¯ | é™ä½é•¿åºåˆ—å†…å­˜ |
| **Mel æå–ä¼˜åŒ–** | NumPy è§†å›¾é›¶æ‹·è´ | æ¶ˆé™¤ librosa å»¶è¿Ÿ |
| **Logits ç¨€ç–è®¡ç®—** | ä»…è®¡ç®— TS ä½ç½® | å¯¹é½æé€Ÿ 2x |
| **è®°å¿†ä¸Šä¸‹æ–‡** | å†å²ç‰‡æ®µæ‹¼æ¥ | æå‡è½¬å½•è¿è´¯æ€§ |

### 6.2 ç²¾åº¦ä¿éšœ

| æŠ€æœ¯ | è¯´æ˜ |
|------|------|
| **K-quants é‡åŒ–** | GGUF Q4_Kï¼Œç²¾åº¦æŸå¤±æœ€å°åŒ– |
| **æ—¶é—´æˆ³ä¿®æ­£** | LIS å•è°ƒæ€§æ£€æµ‹ + çº¿æ€§æ’å€¼ |
| **æ ‡ç‚¹å›å¡«** | Reconcile ç®—æ³•æ¢å¤åŸå§‹æ ‡ç‚¹ |
| **ITN å¤„ç†** | ä¸­æ–‡æ•°å­—è§„æ•´ (ä¸€â†’1) |

### 6.3 è·¨å¹³å°æ”¯æŒ

| å¹³å° | GPU åŠ é€Ÿ | å¤‡æ³¨ |
|------|----------|------|
| Windows | DirectML / Vulkan | DML æ˜¾å­˜å ç”¨æ›´ä½ |
| macOS | Metal | é€šè¿‡ llama.cpp |
| Linux | Vulkan / CUDA | éœ€ç¼–è¯‘ llama.cpp |

### 6.4 å¼‚å¸¸å¤„ç†

```python
# è§£ç ç†”æ–­æœºåˆ¶
if len(stable_tokens) > 15:
    if len(set(stable_tokens[-15:])) <= 3:
        result.is_aborted = True  # æ£€æµ‹åˆ°é‡å¤å¾ªç¯

# æ¸©åº¦åŠ æ¸©é‡è¯•
for i in range(4):
    res = decode(temperature)
    if not res.is_aborted: break
    temperature += 0.3  # é€æ­¥æé«˜æ¸©åº¦
```

---

## 7. å¿«é€Ÿå‚è€ƒ

### 7.1 ç›®å½•ç»“æ„

```
Qwen3-ASR-GGUF/
â”œâ”€â”€ transcribe.py                    # å‘½ä»¤è¡Œå·¥å…· (ä¸»å…¥å£)
â”œâ”€â”€ 21-Run-ASR.py                    # ASR API ç¤ºä¾‹
â”œâ”€â”€ 18-Run-Aligner.py                # Aligner API ç¤ºä¾‹
â”œâ”€â”€ export_config.py                 # æ¨¡å‹è·¯å¾„é…ç½®
â”‚
â”œâ”€â”€ [01-07]  ASR æ¨¡å‹å¯¼å‡ºè„šæœ¬
â”œâ”€â”€ [11-17]  Aligner æ¨¡å‹å¯¼å‡ºè„šæœ¬
â”‚
â”œâ”€â”€ qwen_asr_gguf/
â”‚   â”œâ”€â”€ inference/
â”‚   â”‚   â”œâ”€â”€ asr.py              # æ ¸å¿ƒå¼•æ“
â”‚   â”‚   â”œâ”€â”€ encoder.py          # éŸ³é¢‘ç¼–ç 
â”‚   â”‚   â”œâ”€â”€ aligner.py          # æ—¶é—´æˆ³å¯¹é½
â”‚   â”‚   â”œâ”€â”€ llama.py            # llama.cpp ç»‘å®š
â”‚   â”‚   â”œâ”€â”€ asr_worker.py       # è¾…åŠ©è¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ schema.py           # æ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ exporters.py        # ç»“æœå¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ chinese_itn.py      # ä¸­æ–‡æ•°å­—è§„æ•´
â”‚   â”‚   â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ export/                 # æ¨¡å‹å¯¼å‡ºå·¥å…·
â”‚
â”œâ”€â”€ model/                      # æ¨¡å‹æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ qwen3_asr_*.onnx
â”‚   â”œâ”€â”€ qwen3_asr_*.gguf
â”‚   â””â”€â”€ qwen3_aligner_*.onnx/gguf
â”‚
â””â”€â”€ docs/                       # æ–‡æ¡£
    â””â”€â”€ ARCHITECTURE.md         # æœ¬æ–‡ä»¶
```

### 7.2 æ ¸å¿ƒ API

```python
from qwen_asr_gguf.inference import QwenASREngine, ASREngineConfig, AlignerConfig

# é…ç½®å¼•æ“
config = ASREngineConfig(
    model_dir="model",
    use_dml=True,
    enable_aligner=True,
    align_config=AlignerConfig(use_dml=True)
)

# åˆå§‹åŒ–å¼•æ“
engine = QwenASREngine(config)

# æ‰§è¡Œè½¬å½•
result = engine.transcribe(
    audio_file="test.mp3",
    context="ä¸Šä¸‹æ–‡æç¤º",
    language="Chinese",
    temperature=0.4
)

# å¯¼å‡ºç»“æœ
exporters.export_to_txt("out.txt", result)
exporters.export_to_srt("out.srt", result)
exporters.export_to_json("out.json", result)

# å…³é—­å¼•æ“
engine.shutdown()
```

### 7.3 å‘½ä»¤è¡Œå‚æ•°

```bash
python transcribe.py audio.mp3 \
    --model-dir ./model \
    --prec int4 \
    --dml / --no-dml \
    --vulkan / --no-vulkan \
    --n-ctx 2048 \
    --language Chinese \
    --context "ä¸Šä¸‹æ–‡æç¤º" \
    --chunk-size 40 \
    --memory-num 1 \
    --timestamp / --no-ts
```

### 7.4 å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| è¾“å‡ºä¹±ç  | Intel é›†æ˜¾è®¾ç½® `GGML_VULKAN_DISABLE_F16=1` |
| æ˜¾å­˜ä¸è¶³ | é™ä½ `--n-ctx`ï¼Œä½¿ç”¨ INT4 Encoder |
| é€Ÿåº¦è¿‡æ…¢ | å¼€å¯ DML/Vulkanï¼Œå‡å°‘ `--memory-num` |
| æ—¶é—´æˆ³ä¸å‡† | æ£€æŸ¥éŸ³é¢‘é‡‡æ ·ç‡ (éœ€ 16kHz) |

---

## é™„å½• Aï¼šæ¨¡å‹æ¶æ„å‚æ•°

### ASR æ¨¡å‹ (1.7B)

| ç»„ä»¶ | å‚æ•° |
|------|------|
| Encoder è¾“å…¥ | 128 ç»´ Melï¼Œ16kHz |
| Encoder è¾“å‡º | 896/1024 ç»´ Embedding |
| Decoder å±‚æ•° | 24 å±‚ Transformer |
| è¯è¡¨å¤§å° | 152,064 |
| ä¸Šä¸‹æ–‡çª—å£ | 2048 tokens (é»˜è®¤) |

### Aligner æ¨¡å‹ (0.6B)

| ç»„ä»¶ | å‚æ•° |
|------|------|
| Encoder è¾“å…¥ | 128 ç»´ Melï¼Œ16kHz |
| Encoder è¾“å‡º | 1024 ç»´ Embedding |
| Decoder å±‚æ•° | 12 å±‚ Transformer |
| æ—¶é—´æˆ³ç²¾åº¦ | 80ms/step |
| ä¸Šä¸‹æ–‡çª—å£ | 2048 tokens (é»˜è®¤) |

---

## é™„å½• Bï¼šä¾èµ–ç‰ˆæœ¬

```
torch>=2.0.0
transformers==4.57.6
onnxruntime-directml>=1.16.0  # Windows DML
onnxruntime-gpu>=1.16.0       # Linux/Mac CUDA
gguf>=0.6.0
srt>=3.5.0
numpy>=1.24.0
scipy>=1.10.0
typer>=0.9.0
rich>=13.0.0
PyInstaller>=6.0.0
```

---

**æ–‡æ¡£ç»“æŸ**
